# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

This is an accessibility mod for Cookie Clicker that makes the game usable with screen readers (NVDA, VoiceOver, etc.). It adds ARIA labels, keyboard navigation, live region announcements, and structural headings to the game's DOM.

## Two Distribution Formats

- **`main.js`** — The primary source file for the Steam mod. This is the file you edit.
- **`cookie-clicker-accessibility.user.js`** — Bundled Tampermonkey userscript for the web version. Generated by the build script; do not edit directly.

After editing `main.js`, always copy `main.js` and all relevant files in the `modules` to the Steam install path for testing

##Build (only for Tampermonkey user script)

```bash
./build-userscript.sh
```

This concatenates `userscript-header.txt` + `main.js` into `cookie-clicker-accessibility.user.js` wrapped in an IIFE with a Game-ready polling loop.

This step should only be executed when explicitly requested or when packaging for a Github release. There is no need to build the userscript for testing on the local machine as all testing is done in the Steam build of the game.

## Github Releases

When creating Github releases, make sure that:
- All relevant version numbers are bumped
- The changelog is updated with relevant information
- Two assets are created and uploaded to Github:
	1. A zip named `Cookie-Clicker-Access.zip` containing a `Cookie-Clicker-Access/` folder with `main.js` and `info.txt` (no loose files at the zip root)
	2. A built userscript (refer to above section for details)

## Deploying to Steam for Testing

```bash
cp main.js "/c/Program Files (x86)/Steam/steamapps/common/Cookie Clicker/resources/app/mods/local/Cookie-Clicker-Access/"
```

If modules have been updated:

```bash
cp modules "/c/Program Files (x86)/Steam/steamapps/common/Cookie Clicker/resources/app/mods/local/Cookie-Clicker-Access/"
```

The mod also requires `info.txt` in the same folder (already deployed). Launch Cookie Clicker, enable the mod in Options > Mods.

## Code Architecture

### main.js (~4700 lines)

A single `Game.registerMod("nvda accessibility", { ... })` call containing all mod methods as properties of the mod object. Key sections:

- **`init()`** — Entry point. Sets up state, wraps game functions (`Game.DrawBuildings`, `Game.RebuildUpgrades`, `Game.ToggleSpecialMenu`, `Game.crateTooltip`), registers `draw` and `buy` hooks, then calls enhancement functions after a 500ms delay.
- **`updateDynamicLabels()`** — Called every frame via the `draw` hook. Updates all dynamic ARIA labels (buildings, upgrades, buffs, shimmers, wrinklers, sugar lumps, seasons, etc.). This is the main tick loop.
- **`enhanceUpgradeShop()`** / **`populateProductLabels()`** — Label the store's upgrade crates and building products with accessible descriptions.
- **`filterUnownedBuildings()`** — Hides buildings the player hasn't unlocked yet, showing owned + next + 1 mystery.
- **`enhanceAscensionUI()`** — Makes the prestige screen accessible (heavenly upgrades, permanent slots, chip counter).
- **Minigame enhancers** — `enhanceGardenMinigame()`, `enhancePantheonMinigame()`, `enhanceStockMarketMinigame()`, plus Grimoire handling in `enhanceBuildingMinigames()`.
- **Special systems** — `createDragonPanel()`, `createSantaPanel()`, `createShimmerPanel()`, `createActiveBuffsPanel()`, `createWrinklerOverlays()`.
- **Announcement system** — `announce()` (polite) and `announceUrgent()` (assertive) write to ARIA live regions. Urgent is for shimmers, wrinklers, veil breaks, achievements.

### modules/ (legacy, currently empty)

Previously contained standalone IIFE modules for the web/Tampermonkey build. All minigame logic is now inlined in `main.js` and shared by both Steam and web versions.

### reference/ (read-only)

Original Cookie Clicker source files from Steam (`game-main.js`, `minigame*.js`, `style.css`, `index.html`). Use these to understand game internals. **Never edit.**

## Key Patterns

- **`l('id')`** is the game's shorthand for `document.getElementById('id')`.
- **Visually-hidden elements** use inline `style.cssText` with the clip-rect technique (not a CSS class).
- **Making elements accessible**: set `role="button"`, `tabindex="0"`, add a keydown handler for Enter/Space, and set `dataset.a11yEnhanced = 'true'` to prevent duplicate listeners.
- **`setAttributeIfChanged()` / `setTextIfChanged()`** — Helpers that only write to the DOM when values differ. Use these in the draw loop to avoid unnecessary reflows.
- **Game hooks**: `Game.registerHook('draw', fn)` runs every frame; `Game.registerHook('buy', fn)` runs on purchase.
- **Function wrapping**: The mod wraps several game functions (storing the original, calling it, then running mod logic). Search for `var orig` to find these.

## Accessibility Conventions

- Avoid `role="status"` on frequently-updating elements — it creates a live region that spams the screen reader.
- Don't match buttons by text content (game buttons often contain just "1", "10", "100"). Use element IDs or structural position.
- Avoid hyphens/dashes in `aria-label` values — screen readers can interpret them as minus signs. Use commas instead.
- Stock market heading order preference: name (ticker), owned count, price, trend.
- `.bankSymbol` divs are labels ("Buy"/"Sell"), not buttons — hide with `aria-hidden` to avoid duplication.
